name: Sync Scripts from Source Repos

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:     # Manual trigger
  push:
    paths:
      - '.github/workflows/sync-scripts.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create scripts directory
        run: mkdir -p scripts

      - name: Fetch scripts from source repositories
        run: |
          # Deploy daemon config
          curl -fsSL https://raw.githubusercontent.com/buildplan/docker/refs/heads/main/deploy-daemon-config.sh \
            -o scripts/deploy-daemon-config.sh

          # du_setup - setup Debian/Ubuntu server
          curl -fsSL https://raw.githubusercontent.com/buildplan/du_setup/refs/heads/main/du_setup.sh \
            -o scripts/du_setup.sh

          # Restic backup script (main script only - configs are templates)
          curl -fsSL https://raw.githubusercontent.com/buildplan/restic-backup-script/refs/heads/main/restic-backup.sh \
            -o scripts/restic-backup.sh

          # Container monitor
          curl -fsSL https://raw.githubusercontent.com/buildplan/container-monitor/refs/heads/main/container-monitor.sh \
            -o scripts/container-monitor.sh

          # Add more scripts here as needed
          # curl -fsSL https://raw.githubusercontent.com/USER/REPO/BRANCH/script.sh \
          #   -o scripts/script.sh

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scripts/
          if ! git diff --staged --quiet; then
            git commit -m "chore: sync scripts from source repositories"
            git push
          else
            echo "No changes to commit"
          fi
